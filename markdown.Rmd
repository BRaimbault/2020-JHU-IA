---
title: "Characterizing the spatial distribution of annual particulate matter across California"
author: "Bruno Raimbault"
date: May 3, 2020
output:
  html_document:
    toc: TRUE
    toc_float: true
---



# A. Setup

```{r set_wd, echo=FALSE}
#Set working directory:
knitr::opts_knit$set(root.dir = 'C:/Users/raimb/Work/JHU_2020T04_IA/Designed/Project_1_PM-Cal/')
```

## Data sources

Selected Projection for project: NAD_1983_California_Teale_Albers (WKID: 3310 Authority: EPSG)

| File name |	Source | Overview | URL |
|-----------|--------|----------|-----|
|california_landcover |	USGS	| Land cover (especially developed land) | [URL](https://www.mrlc.gov/data?f%5B0%5D=category%3Aland%20cover) |
|california_dem |	ESRI |	Digital elevation model | [URL](http://hub.arcgis.com/datasets/IVT::california-dem) |
|acs_poverty |	US Census Bureau |	Population in poverty | [URL](https://data.census.gov/cedsci/table?g=0100000US.04000&tid=ACSST5Y2016.S1701&q=S1701) |
|acs_population |	US Census Bureau |	Population | [URL](https://data.census.gov/cedsci/table?g=0100000US.04000&tid=ACSDT5Y2016.B01003) |
|point_pm25 |	EPA |	PM2.5 monitors |  [URL](https://aqs.epa.gov/aqsweb/airdata/download_files.html#Annual) |


## Dependencies

Loading libraries:
```{r libraries_mandatory, message=FALSE}
{library(rgdal); library(geoR); library(ggplot2); library(dplyr); library(splancs); library(summarytools); library(grid);}
```

```{r libraries_optional, include=FALSE}
#Optional libraries (to verify, not loaded for now):
#library(maptools); library(PBSmapping); #library(gstat); #library(splines); #library(rgeos);
```

```{r set_function, echo=FALSE}
footnote <- function(footnoteText=format(Sys.time(), "%d %b %Y"), size= .7, color= grey(.5))
{ pushViewport(viewport())
  grid.text(label= footnoteText , x = unit(1,"npc") - unit(2, "mm"), y= unit(2, "mm"), just=c("right", "bottom"), gp=gpar(cex= size, col=color))
  popViewport()
}
```

# B. Data loading

## State boundaries

Loading California state boundaries shapefile:
```{r data_state, results='hide', fig.align='center'}
shp_california <- readOGR("Projected/area_state_single.shp");
plot(shp_california)
title("Data loading: Californa State boundaries")
footnote('Figure 1')
```

## Monitors data

Loading PM2.5 monitors shapefile:
```{r data_monitors_load, results='hide', fig.align='center'}
shp_monitors <- readOGR("Monitors/point_pm25_all.shp")
plot(shp_california)
points(shp_monitors,col='red')
title("Data loading: Monitors location")
footnote('Figure 2')
```

Convert shapefile to dataframe and to geodata:
```{r data_monitors_convert}
frm_monitors <- data.frame(
  easting=shp_monitors@data$POINT_X, northing=shp_monitors@data$POINT_Y, pm25=shp_monitors@data$meanPM,
  elevation=shp_monitors@data$ELEV, landcover=shp_monitors@data$LCRC, density=shp_monitors@data$POPDEN5, poverty=shp_monitors@data$POVERTY5
)
geo_monitors_pm25 <- as.geodata(frm_monitors,covar.col=3)
```

Check for duplicate monitor locations:
```{r data_monitors_duplicates}
dup.coords(geo_monitors_pm25)
```

Summary table:
```{r data_monitors_summary_pre, echo=FALSE}
isFALSE <- function(x) { identical(x,FALSE) }
```
```{r data_monitors_summary, results='asis'}
st_css()
print(dfSummary(frm_monitors, plain.ascii = FALSE, graph.magnif = 0.85), max.distinct.values = 5, max.string.width=15, method = "render")
```

```{js, echo=FALSE} 
  $( "h3:contains('Data Frame Summary')" ).remove();
  $( "p:contains('Generated by')" ).html("<p style='text-align:right;color:gray;font-size:0.85em;'>Figure 3</p>");
```



## Predictions data

Loading prediction grid shapefile:
```{r data_predictions_load, results='hide', fig.align='center'}
shp_predictions <- readOGR("Point_Grid/point_grid_all.shp")
plot(shp_california)
points(shp_predictions,pch='.',col='blue')
title("Data loading: Predictors location")
footnote('Figure 4')
```

Convert shapefile to dataframe:
```{r data_predictions_convert_frm}
frm_predictions <- data.frame(
  easting=as.numeric(as.character(shp_predictions@data$POINT_X)),
  northing=as.numeric(as.character(shp_predictions@data$POINT_Y)),
  elevation=as.numeric(as.character(shp_predictions@data$ELEV)),
  landcover=as.numeric(as.character(shp_predictions@data$LCRC)), 
  density=as.numeric(as.character(shp_predictions@data$POPDEN5)),
  poverty=as.numeric(as.character(shp_predictions@data$POVERTY5))
)
```

Filter locations where elevation is not available:
```{r data_predictions_filter, results='hide'}
frm_predictions_filtered <- frm_predictions[frm_predictions$elevation != '-9999',]
```

Convert dataframe to geodata:
```{r data_predictions_convert_geo}
geo_predictions_elev <- as.geodata(frm_predictions_filtered,covar.col=3)
geo_predictions_dens <- as.geodata(frm_predictions_filtered,covar.col=5)
geo_predictions_dens$data <- frm_predictions_filtered$density
geo_predictions_pove <- as.geodata(frm_predictions_filtered,covar.col=6)
geo_predictions_pove$data <- frm_predictions_filtered$poverty
```

Check for duplicate prediction locations:
```{r data_predictions_duplicates}
dup.coords(geo_predictions_elev)
```

Summary table on a sample of 9,999 values:
```{r data_predictions_summary_pre, echo=FALSE}
isFALSE <- function(x) { identical(x,FALSE) }
```
```{r data_predictions_summary, results='asis', warning=FALSE, error=FALSE}
st_css()
frm_predictions_sample <- frm_predictions_filtered[sample(nrow(frm_predictions_filtered), 9999), ]
print(dfSummary(frm_predictions_sample, plain.ascii = FALSE, graph.magnif = 0.85), max.distinct.values = 5, max.string.width=15, method = "render")
```

```{js, echo=FALSE} 
  $( "h3:contains('Data Frame Summary')" ).remove();
  $( "p:contains('Generated by')" ).html("<p style='text-align:right;color:gray;font-size:0.85em;'>Figure 5</p>");
```

# C. Exploratory analysis 

## Quick overview of PM2.5 monitors data

Ploting monitors values:
```{r data_monitors_plot, results='hide', fig.align='center'}
area_california <- shp_california@polygons[[1]]@Polygons[[1]]@coords
colors <- c(rgb(252,146,114,maxColorValue=255),rgb(251,106,74,maxColorValue=255),rgb(222,45,38,maxColorValue=255),rgb(165,15,21,maxColorValue=255))
par(oma=c(0,0,2,0))
plot(geo_monitors_pm25, borders=area_california, lowess = TRUE,qt.col = colors)
mtext("PM2.5 Monitors", outer=TRUE,  cex=1.2, line=1)
footnote('Figure 6')
```
```{r, eval=FALSE, include=FALSE}
# Option 2
plot(frm_monitors)
# Option 3
points(geo_monitors_pm25, pt.divide="quartiles", borders=area_california)
```
```{r, eval=FALSE, include=FALSE}
## Plot predictions 
## .............................................................................................
# /!\ Resource-intensive

# plot(frm_predictions_filtered)
# plot(geo_predictions_elev)
# plot(geo_predictions_dens)
# plot(geo_predictions_pove)
```

## Short-scale variations

Estimate the semivariogram form the PM2.5 monitors data and then adjust a model: 
```{r ok_variogram, results='hide', fig.align='center'}
# Estimate semivariogram from data
var_monitors_pm25.dot <- variog(geo_monitors_pm25)
names(var_monitors_pm25.dot)
max <- var_monitors_pm25.dot$max.dist
var_monitors_pm25.dot<-variog(geo_monitors_pm25,max.dist=max/2) #restricting to half the actual maximum distance
plot(var_monitors_pm25.dot,xlab="Distance (meters)",ylab="Semivariogram",pty="m", pch=16, ylim=c(0,11))
title("Semivariogram of PM2.5 Data\n(restricted < 1/2 max distance)")
footnote('Figure 7')

# Adjust semivariogram model
rang <-1.1e+05; sill<- 10; nug  <-0; psill<-sill-nug
model<-"exponential" #"exponential" #"spherical" #"gaussian"
var_monitors_pm25.fit<-variofit(var_monitors_pm25.dot,ini.cov.pars=c(psill,rang),cov.model=model,nugget=nug)
lines(var_monitors_pm25.fit)
```



## Large-scale variations

Find out the maximum and minium extents of our data to create a grid of locations to predict at
```{r ok_grid, results='hide', warning=FALSE}
x_min <- min(area_california[,1])
x_max <- max(area_california[,1])
y_min <- min(area_california[,2])
y_max <- max(area_california[,2])

b_grid1<-expand.grid(easting=seq(x_min-1000,x_max+1000,len=100),northing=seq(y_min-10000,y_max+1000,len=100))
b_grid2<-pip(b_grid1,area_california)
frm_predictions_grid<- as.data.frame(b_grid2)
```

Plot to make sure that the layers all overlay nicely:
```{r ok_check, results='hide', fig.align='center'}
plot(shp_california)
points(frm_predictions_grid, col="blue", pch='.')
points(shp_monitors, col = 'red', pch=1)
title("Layers check")
footnote('Figure 8')
```

Predict values:
```{r ok_predict, results='hide', fig.align='center'}
predictions.OK<-krige.conv(geo_monitors_pm25,locations=frm_predictions_grid,krige=krige.control(obj.model=var_monitors_pm25.fit))
```

Visualize the Ordinary Kriging:
```{r ok_plot_predict, results='hide', fig.align='center', message=FALSE}
ggplot(frm_predictions_grid, aes(x=easting, y=northing)) +  # signify that you are predicting for the entire grid
  geom_tile(aes(fill=predictions.OK$predict)) +   # fill the grid with the predictions.OK$predict values
  coord_equal() + # indicate that the X and Y coordinates you are plotting are on the same scale
  scale_fill_gradient(low = "white", high="red", limits=c(3,16)) + # set the color scale to range from red to yellow
  geom_point(data = shp_monitors@data, aes(x = POINT_X, y = POINT_Y), pch=1) + # add the PM2.5 Monitor locations to the plot
  geom_polygon(data = fortify(shp_california), aes(x = shp_california@polygons[[1]]@Polygons[[1]]@coords[,1], y = shp_california@polygons[[1]]@Polygons[[1]]@coords[,2], group = group), fill = NA, colour = 'black') + # add the states
  ggtitle('Ordinary Kriged Predictions') + # add a title
  theme(plot.title = element_text(hjust = 0.5))
footnote('Figure 9')
```

Visualize the Ordinary Kriging errors:
```{r ok_plot_errors, results='hide', fig.align='center', message=FALSE}
ggplot(frm_predictions_grid, aes(x=easting, y=northing)) +  # signify that you are predicting for the entire grid
  geom_tile(aes(fill=sqrt(predictions.OK$krige.var))) +   # fill the grid with the krige.ok$krige.var values
  coord_equal() + # indicate that the X and Y coordinates you are plotting are on the same scale
  scale_fill_gradient(low = "white", high="orange", limits=c(0,3.5)) + # set the color scale to range from red to yellow
  geom_point(data = shp_monitors@data, aes(x = POINT_X, y = POINT_Y), pch=1) + # add the PM2.5 Monitor locations to the plot
  geom_polygon(data = fortify(shp_california), aes(x = shp_california@polygons[[1]]@Polygons[[1]]@coords[,1], y = shp_california@polygons[[1]]@Polygons[[1]]@coords[,2], group = group), fill = NA, colour = 'black') + # add the states
  ggtitle('Ordinary Kriged Standard Errors') + # add a title
  theme(plot.title = element_text(hjust = 0.5))
footnote('Figure 10')
```


# D. Modelling

## Linear Model
Generation of model:
```{r, results='hide', fig.align='center', message=FALSE}
linear_model_1 <-lm(pm25~elevation+landcover+density+poverty,data=frm_monitors)
```

Model details:

::: {#model1_coefs}
```{r model1_coefs, message=FALSE}
{library(jtools); library(huxtable);}
export_summs(linear_model_1, error_format = "[{conf.low}, {conf.high}]")
```
:::
```{js echo=FALSE}
$("#model1_coefs").first().children().next().before('<center style="font-size:1em;font-weight:bold;">Model 1: Coefficients and Confidence Intervals</center><br>')
$("#model1_coefs").append("<p style='text-align:right;color:gray;font-size:0.85em;'>Figure 11</p>");
```

Visualization of coefficients and confidence intervals:

::: {#model1_coefs_plot}
```{r model1_coefs_plot, fig.show="hold", out.width="50%", message=FALSE}
plot_coefs(linear_model_1, inner_ci_level = .9, coefs = c("Elevation"="elevation", "Landcover"="landcover", "Density"="density", "Poverty"="poverty"))
grid.text(label= 'Non-scaled' , x = unit(0.5,"npc"), y= unit(1, "npc"), just=c("center", "top"), gp=gpar(cex= 1.2, col='black'))
plot_summs(linear_model_1,scale = TRUE, inner_ci_level = .9)
grid.text(label= 'Scaled' , x = unit(0.5,"npc"), y= unit(1, "npc"), just=c("center", "top"), gp=gpar(cex= 1.2, col='black'))
```
:::
```{js echo=FALSE}
$("#model1_coefs_plot").first().children().next().before('<center style="font-size:1em;font-weight:bold;">Model 1: Coefficients and Confidence Intervals</center><br>');
$("#model1_coefs_plot").append("<p style='text-align:right;color:gray;font-size:0.85em;'>Figure 12</p>");

```

Elements of model evaluation ([more information](https://data.library.virginia.edu/diagnostic-plots/)):

::: {#model1_analysis}
```{r, fig.show="hold", out.width="50%", message=FALSE}
plot(linear_model_1)
```
:::
```{js echo=FALSE}
$("#model1_analysis").first().children().next().before('<center style="font-size:1em;font-weight:bold;">Model 1: Analysis</center><br>');
$("#model1_analysis").append("<p style='text-align:right;color:gray;font-size:0.85em;'>Figure 13</p>");
```

## Residuals
Store and convert residuals to geodata:
```{r, results='hide', fig.align='center', message=FALSE}
resid<-linear_model_1$residuals
geo_monitors_resid<-as.geodata(cbind(geo_monitors_pm25$coords,resid))
```
Preliminary visualisation of residuals:
```{r, results='hide', fig.align='center', message=FALSE}
colors <- c(rgb(253,174,107,maxColorValue=255),rgb(253,141,60,maxColorValue=255),rgb(230,85,13,maxColorValue=255),rgb(166,54,3,maxColorValue=255))
par(oma=c(0,0,2,0))
plot(geo_monitors_resid, borders=area_california, lowess = TRUE,qt.col = colors) 
mtext("PM2.5 Monitors Residuals", outer=TRUE,  cex=1.2, line=1)
footnote('Figure 14')
```
Estimate the semivariogram form the PM2.5 monitors results and then adjust a model:
```{r, results='hide', fig.align='center', message=FALSE}
# Estimate semivariogram from data
var_monitors_resid.dot <- variog(geo_monitors_resid)
names(var_monitors_resid.dot)
max <- var_monitors_resid.dot$max.dist
var_monitors_resid.dot<-variog(geo_monitors_resid,max.dist=max/2) #restricting to half the actual maximum distance
plot(var_monitors_resid.dot,xlab="Distance (meters)",ylab="Semivariogram",pty="m", pch=16, ylim=c(0,11))
title("Residual semivariogram for PM2.5 Model\n(restricted < 1/2 max distance)")
footnote('Figure 15')

## Adjust semivariogram model
rang <-6e+04; sill<- 6; nug  <-0; psill<-sill-nug
model<-"exponential" #"exponential" #"spherical" #"gaussian"
var_monitors_resid.fit<-variofit(var_monitors_resid.dot,ini.cov.pars=c(psill,rang),cov.model=model,nugget=nug)
lines(var_monitors_resid.fit)
```

## Universal Kriging
Predict values:
```{r, results='hide', fig.align='center', message=FALSE}
predictions.UK<-krige.conv(geo_monitors_pm25,locations=frm_predictions_grid, krige=krige.control(obj.model=var_monitors_resid.fit, trend.d=predict(linear_model_1, frm_monitors, interval = "prediction"), trend.l=predict(linear_model_1, frm_predictions_filtered, interval = "prediction")))
```

Visualize the Universal Kriging
```{r, results='hide', fig.align='center', message=FALSE}
ggplot(frm_predictions_grid, aes(x=easting, y=northing)) +  # signify that you are predicting for the entire grid
  geom_tile(aes(fill=predictions.UK$predict)) +   # fill the grid with the predictions.OK$predict values
  coord_equal() + # indicate that the X and Y coordinates you are plotting are on the same scale
  scale_fill_gradient(low = "white", high="red", limits=c(3,16)) + # set the color scale to range from red to yellow
  geom_point(data = shp_monitors@data, aes(x = POINT_X, y = POINT_Y), pch=1) + # add the PM2.5 Monitor locations to the plot
  geom_polygon(data = fortify(shp_california), aes(x = shp_california@polygons[[1]]@Polygons[[1]]@coords[,1], y = shp_california@polygons[[1]]@Polygons[[1]]@coords[,2], group = group), fill = NA, colour = 'black') + # add the states
  ggtitle('Universally Kriged Predictions') + # add a title
  theme(plot.title = element_text(hjust = 0.5)) # centres the title
footnote('Figure 16')
```

Visualize the Universal Kriging errors
```{r, results='hide', fig.align='center', message=FALSE}
ggplot(frm_predictions_grid, aes(x=easting, y=northing)) +  # signify that you are predicting for the entire grid
  geom_tile(aes(fill=sqrt(predictions.UK$krige.var))) +   # fill the grid with the krige.ok$krige.var values
  coord_equal() + # indicate that the X and Y coordinates you are plotting are on the same scale
  scale_fill_gradient(low = "white", high="orange", limits=c(0,3.5)) + # set the color scale to range from red to yellow
  geom_point(data = shp_monitors@data, aes(x = POINT_X, y = POINT_Y), pch=1) + # add the PM2.5 Monitor locations to the plot
  geom_polygon(data = fortify(shp_california), aes(x = shp_california@polygons[[1]]@Polygons[[1]]@coords[,1], y = shp_california@polygons[[1]]@Polygons[[1]]@coords[,2], group = group), fill = NA, colour = 'black') + # add the states
  ggtitle('Universally Kriged Standard Errors') + # add a title
  theme(plot.title = element_text(hjust = 0.5)) # centres the title
footnote('Figure 17')
```
